<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Integração Memed</title>
</head>
<body>
  <div id="loading">Carregando prescrição Memed...</div>
  <div id="error" style="display:none;color:#c62828;"></div>

  <script>
    function getUrlParams() {
      const p = new URLSearchParams(window.location.search);
      return {
        prescritorId: p.get("prescritorId"),
        pacienteId: p.get("pacienteId"),
        nome: p.get("pacienteNome") || p.get("nome"),
        email: p.get("pacienteEmail") || p.get("email"),
        telefone: p.get("pacienteTelefone") || p.get("telefone"),
        cpf: p.get("pacienteCpf") || p.get("cpf"),
        nascimento: p.get("pacienteDataNascimento") || p.get("nascimento"),
        endereco: p.get("endereco")
      };
    }

    function showError(msg) {
      document.getElementById("loading").style.display = "none";
      const e = document.getElementById("error");
      e.style.display = "block";
      e.textContent = msg;
      console.error(msg);
    }

    async function getToken(prescritorId) {
      const url = `https://memed-token.rafaella-erbella.workers.dev/api/token?prescritorId=${encodeURIComponent(prescritorId)}`;
      const r = await fetch(url);
      if (!r.ok) throw new Error(`Erro token: HTTP ${r.status}`);
      const j = await r.json();
      if (!j.token) throw new Error("Resposta sem token");
      return j.token;
    }

    async function loadMemed() {
      const params = getUrlParams();
      if (!params.prescritorId) return showError("Falta ?prescritorId=");

      let token;
      try {
        token = await getToken(params.prescritorId);
      } catch (err) {
        return showError(err.message);
      }

      const script = document.createElement("script");
      script.src = "https://integrations.memed.com.br/modulos/plataforma.sinapse-prescricao/build/sinapse-prescricao.min.js";
      script.dataset.token = token;

      script.onload = () => {
        // Quando o módulo estiver pronto, setamos paciente e mostramos a prescrição
        MdSinapsePrescricao.event.add("core:moduleInit", async function(module) {
          if (module.name !== "plataforma.prescricao") return;

          const paciente = {};
          if (params.pacienteId) paciente.idExterno = String(params.pacienteId);
          if (params.nome) paciente.nome = params.nome;
          if (params.email) paciente.email = params.email;
          if (params.telefone) paciente.telefone = params.telefone;
          if (params.cpf) paciente.cpf = params.cpf;
          if (params.nascimento) paciente.data_nascimento = params.nascimento; // dd/mm/yyyy se você estiver passando assim
          if (params.endereco) paciente.endereco = params.endereco;

          // Se você quiser forçar campos obrigatórios:
          if (!paciente.nome) return showError("Falta nome do paciente");
          if (!paciente.telefone) return showError("Falta telefone do paciente");

          try {
            await MdHub.command.send("plataforma.prescricao", "setPaciente", paciente);
            document.getElementById("loading").style.display = "none";
            MdHub.module.show("plataforma.prescricao");
          } catch (e) {
            showError("Falha no setPaciente: " + (e?.message || String(e)));
          }
        });
      };

      script.onerror = () => showError("Erro ao carregar script da Memed");
      document.body.appendChild(script);
    }

    loadMemed();
  </script>
</body>
</html>
