<script>
  const WORKER_URL =
    "https://memed-token.rafaella-erbella.workers.dev/memed/token";

  // L√™ par√¢metros da URL (ex.: ?nome=Joao&cpf=11122233344)
  const params = new URLSearchParams(window.location.search);

  const paciente = {
    idExterno: params.get("idExterno") || "paciente-teste-001",
    nome: params.get("nome") || "Paciente Teste",
    telefone: params.get("telefone") || "11999999999",
    cpf: params.get("cpf") || "43328886850",
    nome_social: params.get("nome_social") || "",
    endereco: params.get("endereco") || "Rua Exemplo, 123 - S√£o Paulo/SP",
    categoriesConditions: [] // por enquanto vazio
  };

  let memedCarregada = false;

  async function obterTokenMemed() {
    const resp = await fetch(WORKER_URL);
    if (!resp.ok) throw new Error("Erro ao obter token Memed");
    const { token } = await resp.json();
    return token;
  }

  async function carregarScriptMemed() {
    const token = await obterTokenMemed();

    return new Promise((resolve, reject) => {
      const script = document.createElement("script");
      script.src =
        "https://integrations.memed.com.br/modulos/plataforma.sinapse-prescricao/build/sinapse-prescricao.min.js";
      script.dataset.token = token;

      script.onload = () => {
        console.log("‚úÖ Script Memed carregou");
        resolve();
      };
      script.onerror = (e) => {
        console.error("‚ùå Script Memed N√ÉO carregou", e);
        reject(e);
      };

      document.body.appendChild(script);
    });
  }

  function configurarEventosMemed() {
    MdSinapsePrescricao.event.add("core:moduleInit", async function (module) {
      console.log("üì¶ core:moduleInit:", module.name);

      if (module.name === "plataforma.prescricao") {
        console.log("‚úÖ Memed pronta (plataforma.prescricao)");

        await MdHub.command.send(
          "plataforma.prescricao",
          "setPaciente",
          paciente
        );

        // Por enquanto vamos comentar os exemplos de alergia e item fixo
        // await MdHub.command.send("plataforma.prescricao", "setAllergy", [622]);
        // await MdHub.command.send("plataforma.prescricao", "addItem", { ... });

        await MdHub.command.send(
          "plataforma.prescricao",
          "setFeatureToggle",
          {
            editPatient: false,
            guidesOnboarding: false
          }
        );

        MdHub.module.show("plataforma.prescricao");
      }
    });
  }

  document
    .getElementById("abrirMemed")
    .addEventListener("click", async () => {
      try {
        if (!memedCarregada) {
          await carregarScriptMemed();
          configurarEventosMemed();
          memedCarregada = true;
        } else {
          MdHub.module.show("plataforma.prescricao");
        }
      } catch (err) {
        console.error("‚ùå Erro ao abrir Memed", err);
      }
    });
</script>
