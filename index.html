<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="strict-origin-when-cross-origin" />
  <title>Prescrição Memed</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    #loading { padding: 12px; color: #555; }
    #error {
      display:none; padding:12px; border-radius:6px;
      background:#ffebee; border:1px solid #ef5350; color:#c62828;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div id="loading">Carregando prescrição Memed…</div>
  <div id="error"></div>

  <script>
    // ====== CONFIG (produção) ======
    const TOKEN_ENDPOINT = "https://memed-api.raeclinicadigital.com/api/token";
    const MEMED_SCRIPT_URL = "https://partners.memed.com.br/integration.js";

    // ====== Helpers ======
    function qs(k){ return new URLSearchParams(location.search).get(k); }
    function onlyDigits(s){ return (s || "").replace(/\D+/g, ""); }

    function showError(msg){
      document.getElementById("loading").style.display = "none";
      const e = document.getElementById("error");
      e.style.display = "block";
      e.textContent = msg;
    }

    async function getToken(prescritorId){
      const url = `${TOKEN_ENDPOINT}?prescritorId=${encodeURIComponent(prescritorId)}`;

      const r = await fetch(url, {
        method: "GET",
        headers: { "Accept": "application/json" },
        cache: "no-store",
      });

      const j = await r.json().catch(() => ({}));

      if (!r.ok) {
        throw new Error(`Erro ao obter token (HTTP ${r.status}): ${JSON.stringify(j)}`);
      }
      if (!j || !j.token) {
        throw new Error("Resposta do memed-worker não retornou token.");
      }
      return j.token;
    }

    // Monta paciente SOMENTE se tiver obrigatórios.
    // Obrigatórios (doc): idExterno, nome, cpf (só dígitos), sexo.
    function buildPacienteFromQS(){
      const idExterno = qs("pacienteId") ? String(qs("pacienteId")) : "";
      const nome = (qs("nome") || "").trim();
      const cpf = onlyDigits(qs("cpf"));
      const sexo = (qs("sexo") || "").trim(); // mande "F"/"M" ou "Feminino"/"Masculino"

      if (!idExterno || !nome || !cpf || !sexo) return null;

      const paciente = { idExterno, nome, cpf, sexo };

      const telefone = onlyDigits(qs("telefone"));
      if (telefone) paciente.telefone = telefone;

      const nasc = (qs("nascimento") || "").trim(); // dd/mm/AAAA
      if (nasc) paciente.data_nascimento = nasc;

      const email = (qs("email") || "").trim();
      if (email) paciente.email = email;

      const nome_social = (qs("nome_social") || "").trim();
      if (nome_social) paciente.nome_social = nome_social;

      const raca = (qs("raca") || "").trim(); // "branca", "parda", etc (minúsculas)
      if (raca) paciente.raca = raca.toLowerCase();

      return paciente;
    }

    async function main(){
      const prescritorId = qs("prescritorId");
      if (!prescritorId) return showError("Falta ?prescritorId=<id>");

      let token;
      try {
        token = await getToken(prescritorId);
      } catch (e) {
        return showError(e.message || String(e));
      }

      // Injeta o script da Memed (produção)
      const s = document.createElement("script");
      s.src = MEMED_SCRIPT_URL;
      s.dataset.token = token;

      s.onload = () => {
        // Só execute comandos após o módulo carregar
        MdSinapsePrescricao.event.add("core:moduleInit", async (module) => {
          if (module.name !== "plataforma.prescricao") return;

          const paciente = buildPacienteFromQS();
          if (paciente) {
            try {
              await MdHub.command.send("plataforma.prescricao", "setPaciente", paciente);
            } catch (e) {
              console.warn("Falha setPaciente:", e);
              // Não bloqueia abertura da Memed
            }
          }

          document.getElementById("loading").style.display = "none";
          MdHub.module.show("plataforma.prescricao");
        });
      };

      s.onerror = () => showError("Erro ao carregar script da Memed (produção).");
      document.body.appendChild(s);
    }

    main();
  </script>
</body>
</html>
