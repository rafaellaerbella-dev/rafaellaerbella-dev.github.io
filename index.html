<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Prescri√ß√£o Memed</title>
</head>

<body>
  <button id="abrirMemed">Abrir prescri√ß√£o</button>

  <!-- s√≥ um container vazio para manter estrutura -->
  <div id="memed-container"></div>

  <script>
    // URL do Worker que gera o token do prescritor
    const WORKER_URL =
      "https://memed-token.rafaella-erbella.workers.dev/memed/token";

    // L√™ par√¢metros da URL, exemplo:
    // ?nome=Joao+Silva&cpf=11122233344&telefone=11988887777&idExterno=paciente-joao-1
    const params = new URLSearchParams(window.location.search);

    const paciente = {
      idExterno: "2",
      nome: "Rafael Falk Giannotti",
      telefone: "11970399942",
      cpf: "45528090830",
      endereco: "Rua Inhambu, 973 - Apto 53A - Vila Uberabinha - Sao Paulo/SP - CEP 04520-013",
      ...
    };

    let memedCarregada = false;

    async function obterTokenMemed() {
      const resp = await fetch(WORKER_URL);
      if (!resp.ok) throw new Error("Erro ao obter token Memed");

      const { token } = await resp.json();
      return token;
    }

    async function carregarScriptMemed() {
      const token = await obterTokenMemed();

      return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src =
          "https://integrations.memed.com.br/modulos/plataforma.sinapse-prescricao/build/sinapse-prescricao.min.js";
        script.dataset.token = token;

        script.onload = () => {
          console.log("‚úÖ Script Memed carregou");
          resolve();
        };
        script.onerror = (e) => {
          console.error("‚ùå Script Memed N√ÉO carregou", e);
          reject(e);
        };

        document.body.appendChild(script);
      });
    }

    function configurarEventosMemed() {
      MdSinapsePrescricao.event.add("core:moduleInit", async (module) => {
        console.log("üì¶ core:moduleInit:", module.name);

        if (module.name === "plataforma.prescricao") {
          console.log("‚úÖ Memed pronta (plataforma.prescricao)");

          // envia o paciente (j√° vindo da URL)
          await MdHub.command.send(
            "plataforma.prescricao",
            "setPaciente",
            paciente
          );

          // voc√™ pode reativar setAllergy/addItem depois, se quiser
          /*
          await MdHub.command.send("plataforma.prescricao", "setAllergy", [622]);

          await MdHub.command.send("plataforma.prescricao", "addItem", {
            id: "w4103",
            posologia: "<p>HTML da posologia</p>",
            quantidade: 1,
            unit: "embalagens"
          });
          */

          await MdHub.command.send(
            "plataforma.prescricao",
            "setFeatureToggle",
            {
              editPatient: false,
              guidesOnboarding: false
            }
          );

          MdHub.module.show("plataforma.prescricao");
        }
      });
    }

    document
      .getElementById("abrirMemed")
      .addEventListener("click", async () => {
        try {
          if (!memedCarregada) {
            await carregarScriptMemed();
            configurarEventosMemed();
            memedCarregada = true;
          } else {
            MdHub.module.show("plataforma.prescricao");
          }
        } catch (err) {
          console.error("‚ùå Erro ao abrir Memed", err);
        }
      });
  </script>
</body>
</html>
