<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="strict-origin-when-cross-origin" />
  <title>Prescrição Memed</title>
  <style>
    #loading { padding: 20px; color: #555; font-family: Arial, sans-serif; }
    #error { display:none; padding:12px; background:#ffebee; color:#c62828; font-family: Arial, sans-serif; }
  </style>
</head>
<body>
  <div id="loading">Carregando prescrição Memed…</div>
  <div id="error"></div>

  <script>
    // ====== CONFIG (produção) ======
    const TOKEN_ENDPOINT = "https://memed-api.raeclinicadigital.com/api/token";
    const MEMED_SCRIPT_URL = "https://partners.memed.com.br/integration.js";

    // ====== Helpers ======
    function qs(k){ return new URLSearchParams(location.search).get(k); }
    function onlyDigits(s){ return (s || "").replace(/\D+/g, ""); }

    function showError(msg){
      document.getElementById("loading").style.display = "none";
      const e = document.getElementById("error");
      e.style.display = "block";
      e.textContent = msg;
    }

    async function getToken(){
      // Chama endpoint sem prescritorId - o backend usa o default
      const r = await fetch(TOKEN_ENDPOINT, {
        method: "GET",
        headers: { "Accept": "application/json" },
        cache: "no-store",
      });

      const j = await r.json().catch(() => ({}));

      if (!r.ok) {
        throw new Error(`Erro ao obter token (HTTP ${r.status}): ${JSON.stringify(j)}`);
      }
      if (!j || !j.token) {
        throw new Error("Resposta do memed-worker não retornou token.");
      }
      return j.token;
    }

    // Monta paciente SOMENTE se tiver obrigatórios.
    // Obrigatórios (doc): idExterno, nome, cpf (só dígitos), sexo.
    function buildPacienteFromQS(){
      const idExterno = qs("pacienteId") ? String(qs("pacienteId")) : "";
      const nome = (qs("nome") || "").trim();
      const cpf = onlyDigits(qs("cpf"));
      const sexo = (qs("sexo") || "").trim(); // mande "F"/"M" ou "Feminino"/"Masculino"

      if (!idExterno || !nome || !cpf || !sexo) return null;

      const paciente = { idExterno, nome, cpf, sexo };

      const telefone = onlyDigits(qs("telefone"));
      if (telefone) paciente.telefone = telefone;

      const nasc = (qs("nascimento") || "").trim(); // dd/mm/AAAA
      if (nasc) paciente.data_nascimento = nasc;

      const email = (qs("email") || "").trim();
      if (email) paciente.email = email;

      const nome_social = (qs("nome_social") || "").trim();
      if (nome_social) paciente.nome_social = nome_social;

      const raca = (qs("raca") || "").trim(); // "branca", "parda", etc (minúsculas)
      if (raca) paciente.raca = raca.toLowerCase();

      return paciente;
    }

    async function main(){
      // Safari: Pedir permissão de cookies de terceiros
      if (document.hasStorageAccess && document.requestStorageAccess) {
        try {
          const hasAccess = await document.hasStorageAccess();
          if (!hasAccess) {
            console.log("Safari: Solicitando Storage Access...");
            await document.requestStorageAccess();
            console.log("Safari: Storage Access concedido!");
          } else {
            console.log("Safari: Storage Access já disponível");
          }
        } catch (e) {
          console.warn("Safari: Storage Access negado ou não suportado:", e);
        }
      }

      // Token pode vir via URL (quando aberto pelo SPA) ou busca da API
      let token = qs("token");
      if (!token) {
        try {
          token = await getToken();
        } catch (e) {
          return showError("Token não fornecido e não foi possível obter: " + (e.message || String(e)));
        }
      }

      // Injeta o script da Memed (produção)
      const s = document.createElement("script");
      s.src = MEMED_SCRIPT_URL;
      s.dataset.token = token;

      s.onload = () => {
        // Só execute comandos após o módulo carregar
        MdSinapsePrescricao.event.add("core:moduleInit", async (module) => {
          if (module.name !== "plataforma.prescricao") return;

          const paciente = buildPacienteFromQS();
          if (paciente) {
            try {
              await MdHub.command.send("plataforma.prescricao", "setPaciente", paciente);
            } catch (e) {
              console.warn("Falha setPaciente:", e);
              // Não bloqueia abertura da Memed
            }
          }

          document.getElementById("loading").style.display = "none";
          MdHub.module.show("plataforma.prescricao");

          // Captura evento de prescrição conforme documentação Memed
          MdHub.event.add("prescricaoImpressa", function(prescriptionData) {
            console.log("[github index.html] prescricaoImpressa recebido:", prescriptionData);

            // Tenta extrair medicamentos de vários caminhos possíveis
            let medicamentos = [];
            if (prescriptionData.medicamentos) {
              medicamentos = prescriptionData.medicamentos;
            } else if (prescriptionData.prescricao?.medicamentos) {
              medicamentos = prescriptionData.prescricao.medicamentos;
            } else if (prescriptionData["prescrição"]?.medicamentos) {
              medicamentos = prescriptionData["prescrição"].medicamentos;
            } else if (Array.isArray(prescriptionData)) {
              medicamentos = prescriptionData;
            }

            const atendimentoId = qs("atendimentoId");
            const pacienteId = qs("pacienteId");

            const payload = {
              type: "prescricaoMemed",
              atendimentoId: atendimentoId,
              pacienteId: pacienteId,
              prescriptionData: prescriptionData,
              medicamentos: medicamentos,
              timestamp: new Date().toISOString()
            };

            // Envia para window.opener (se aberto via window.open)
            if (window.opener && !window.opener.closed) {
              console.log("[github index.html] Enviando postMessage para opener:", payload);
              window.opener.postMessage(payload, "*");
            }

            // Envia para parent (se em iframe)
            if (window.parent && window.parent !== window) {
              console.log("[github index.html] Enviando postMessage para parent:", payload);
              window.parent.postMessage(payload, "*");
            }
          });
        });
      };

      s.onerror = () => showError("Erro ao carregar script da Memed (produção).");
      document.body.appendChild(s);
    }

    main();
  </script>
</body>
</html>
