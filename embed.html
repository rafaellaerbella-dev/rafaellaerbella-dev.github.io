<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />

    <title>Memed ‚Äì Prescri√ß√£o (debug)</title>

    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
      }

      #bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 99999;
        background: #111;
        color: #fff;
        padding: 10px 12px;
        font-size: 12px;
      }

      #log {
        white-space: pre-wrap;
        word-break: break-word;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      }

      #memed-host {
        position: fixed;
        top: 110px;
        left: 0;
        right: 0;
        bottom: 0;
        background: #f7f7f7;
      }

      .ok {
        color: #7cfc00;
      }

      .bad {
        color: #ff6b6b;
      }

      button {
        margin-left: 8px;
      }
    </style>
  </head>

  <body>
    <div id="bar">
      <div>
        <b>Status:</b>
        <span id="status">carregando‚Ä¶</span>
        <button id="clear">Limpar</button>
      </div>

      <div id="log"></div>
    </div>

    <div id="memed-host"></div>
    <div id="memed-container"></div>

    <script>
      const statusEl = document.getElementById("status");
      const logEl = document.getElementById("log");

      const log = (...args) => {
        const line = args
          .map((a) =>
            typeof a === "string" ? a : JSON.stringify(a, null, 2)
          )
          .join(" ");

        logEl.textContent +=
          (logEl.textContent ? "\n" : "") + line;

        console.log(...args);
      };

      document.getElementById("clear").onclick = () => {
        logEl.textContent = "";
      };

      window.addEventListener("error", (e) => {
        log(
          "‚ùå window.error:",
          e.message,
          " @",
          `${e.filename}:${e.lineno}:${e.colno}`
        );
      });

      window.addEventListener("unhandledrejection", (e) => {
        log("‚ùå unhandledrejection:", String(e.reason));
      });

      // loga requests falhos (fetch)
      const _fetch = window.fetch;

      window.fetch = async (...args) => {
        const res = await _fetch(...args);

        if (!res.ok) {
          log("‚ö†Ô∏è fetch n√£o-ok:", res.status, res.url);
        }

        return res;
      };

      // marca que a p√°gina carregou
      statusEl.innerHTML = '<span class="ok">HTML ok</span>';
      log("‚úÖ HTML carregou");
    </script>

    <!-- Script Memed -->
    <script
      src="https://integrations.memed.com.br/modulos/plataforma.sinapse-prescricao/build/sinapse-prescricao.min.js"
      data-token="COLE_AQUI_O_TOKEN_DO_PRESCRITOR"
      onload="
        document.getElementById('status').innerHTML =
          '<span class=ok>Script Memed carregou</span>';
        document.getElementById('log').textContent +=
          '\n‚úÖ Script Memed carregou';
      "
      onerror="
        document.getElementById('status').innerHTML =
          '<span class=bad>Script Memed N√ÉO carregou</span>';
        document.getElementById('log').textContent +=
          '\n‚ùå Script Memed N√ÉO carregou';
      "
      ></script>

      <script>
        function findHub(obj) {
          try {
            const candidates = [
              obj?.hub,
              obj?.Hub,
              obj?.mdHub,
              obj?.MdHub,
              obj?.mdhub,
              obj?.runtime?.hub,
              obj?.runtime?.MdHub,
              obj?.runtime?.mdHub,
              obj?.runtime?.core?.hub,
              obj?.core?.hub,
              obj?.core?.MdHub
            ].filter(Boolean);
      
            return candidates[0] || null;
          } catch {
            return null;
          }
        }
      </script>
    
      <script>
        (function () {
          const statusEl = document.getElementById("status");
          const logEl = document.getElementById("log");
      
          const log = (...args) => {
            const line = args
              .map((a) => (typeof a === "string" ? a : JSON.stringify(a, null, 2)))
              .join(" ");
            logEl.textContent += (logEl.textContent ? "\n" : "") + line;
            console.log(...args);
          };
      
          const keys = Object.keys(window).filter((k) =>
            k.toLowerCase().includes("md") ||
            k.toLowerCase().includes("sinapse") ||
            k.toLowerCase().includes("memed") ||
            k.toLowerCase().includes("hub")
          );
      
          log("üîé globais poss√≠veis:", keys);
          log("window.MdHub =", window.MdHub ? "OK" : "undefined");
          log("window.MdSinapsePrescricao =", window.MdSinapsePrescricao ? "OK" : "undefined");
      
          // Espera o runtime da Memed inicializar
          if (window.MdSinapsePrescricao?.event?.add) {
            MdSinapsePrescricao.event.add("core:moduleInit", function (module) {
              log("üì¶ core:moduleInit:", module?.name);
      
              if (module?.name === "plataforma.prescricao") {
                if (window.MdHub?.module?.show) {
                  log("‚û°Ô∏è MdHub.module.show(plataforma.prescricao)");
                  MdHub.module.show("plataforma.prescricao");
                } else {
                  log("‚ùå MdHub ainda n√£o existe. Prov√°vel token/dom√≠nio n√£o autorizado.");
                }
              }
            });
          } else {
            log("‚ùå MdSinapsePrescricao.event.add n√£o dispon√≠vel. Script n√£o inicializou runtime.");
          }
        })();
      </script>

  </body>
</html>
