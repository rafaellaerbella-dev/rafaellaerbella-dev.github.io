<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Memed integrada ao Ninsaúde</title>
</head>

<body>

  <!-- Script oficial da Memed -->
  <script
    src="https://integrations.memed.com.br/modulos/plataforma.sinapse-prescricao/build/sinapse-prescricao.min.js"
    data-token="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.WzkwMzg3LCIwYTZiZTgwM2U1YTcwNTg5NDJmZGQ2NmU3MzU2YWM1MSIsIjIwMjYtMDEtMjIiLCJzaW5hcHNlLnByZXNjcmljYW8iLCJwYXJ0bmVyLjMuODU1MjAiXQ.DbTqxosooGFCD6OhWW_ClktXPZN4B1Ecnev4OsavoXs">
  </script>

  <script>
    let pacienteRecebido = null;
    let integrado = false;

    // 1️⃣ Recebe paciente do Ninsaúde
    window.addEventListener("message", function (event) {
      // Em produção, restrinja o origin
      // if (event.origin !== "https://clinic.ninsaude.com.br") return;

      if (!event.data || event.data.type !== "PACIENTE_NINSAUDE") return;

      pacienteRecebido = event.data.payload;
    });

    // 2️⃣ Espera o MdHub existir (TIMING CORRETO)
    const waitForMdHub = setInterval(() => {
      if (!window.MdHub || !window.MdHub.command) return;

      clearInterval(waitForMdHub);

      // Espera o módulo de prescrição estar pronto
      MdHub.event.add("core:moduleInit", function (module) {
        if (module.name !== "plataforma.prescricao") return;
        if (integrado) return;

        integrado = true;

        if (!pacienteRecebido) {
          console.warn("Paciente ainda não recebido do Ninsaúde");
          return;
        }

        integrarPaciente(pacienteRecebido);
      });
    }, 200);

    // 3️⃣ Integra paciente + endereço
    function integrarPaciente(p) {
      // Identidade
      MdHub.command.send("plataforma.prescricao", "setPaciente", {
        nome: p.nome,
        sexo: p.sexo,
        dataNascimento: p.dataNascimento, // YYYY-MM-DD
        documento: p.cpf,
        external_id: p.id
      });

      // Endereço (controlados)
      if (p.endereco) {
        MdHub.command.send("plataforma.prescricao", "setEnderecoPaciente", {
          logradouro: p.endereco.logradouro,
          numero: p.endereco.numero,
          complemento: p.endereco.complemento,
          bairro: p.endereco.bairro,
          cidade: p.endereco.cidade,
          uf: p.endereco.uf,
          cep: p.endereco.cep
        });
      }

      // Abre direto a prescrição
      MdHub.command.send("plataforma.prescricao", "openPrescription");
      MdHub.module.show("plataforma.prescricao");
    }
  </script>

</body>
</html>
