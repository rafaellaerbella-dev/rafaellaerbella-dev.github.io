<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Prescri√ß√£o Memed</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
    }
    button {
      padding: 10px 16px;
      font-size: 15px;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <button id="abrirMemed">Abrir prescri√ß√£o</button>

  <script>
    const WORKER_URL =
      "https://memed-token.rafaella-erbella.workers.dev/memed/token";

    let memedReady = false;

    // 1Ô∏è‚É£ Buscar token no backend (Cloudflare Worker)
    async function obterTokenMemed() {
      const resp = await fetch(WORKER_URL, {
        method: "POST"
      });

      if (!resp.ok) {
        throw new Error("Erro ao obter token da Memed");
      }

      const data = await resp.json();
      return data.token;
    }

    // 2Ô∏è‚É£ Carregar script da Memed dinamicamente
    async function carregarMemed() {
      const token = await obterTokenMemed();

      return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src =
          "https://integrations.memed.com.br/modulos/plataforma.sinapse-prescricao/build/sinapse-prescricao.min.js";
        script.dataset.token = token;

        script.onload = () => {
          console.log("‚úÖ Script Memed carregado");
          resolve();
        };

        script.onerror = () => reject("Erro ao carregar script Memed");

        document.body.appendChild(script);
      });
    }

    // 3Ô∏è‚É£ Inicializa√ß√£o da Memed
    function inicializarMemed() {
      MdSinapsePrescricao.event.add(
        "core:moduleInit",
        async function (module) {
          if (module.name === "plataforma.prescricao") {
            console.log("‚úÖ Memed pronta");
            memedReady = true;
          }
        }
      );
    }

    // 4Ô∏è‚É£ Clique do bot√£o
    document
      .getElementById("abrirMemed")
      .addEventListener("click", async () => {
        try {
          console.log("üü¢ Clique no bot√£o");

          if (!window.MdHub) {
            await carregarMemed();
            inicializarMemed();
          }

          if (!memedReady) {
            console.log("‚è≥ Aguardando Memed ficar pronta‚Ä¶");
            return;
          }

          // Apenas abre a Memed (sem paciente ainda)
          MdHub.module.show("plataforma.prescricao");
        } catch (err) {
          console.error("‚ùå Erro ao abrir Memed", err);
        }
      });
  </script>

</body>
</html>
