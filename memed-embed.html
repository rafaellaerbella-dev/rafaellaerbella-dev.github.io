<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Prescrição</title>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #fff;
      }
    </style>
  </head>

  <body>

    <script>
      /************************************************************
       * 1. RECEBE DADOS DO NINSAÚDE
       ************************************************************/
      if (!window.NINSAUDE_MEMED) {
        console.error("❌ Dados do Ninsaúde não encontrados");
        throw new Error("Integração Memed sem dados");
      }

      const { token, paciente } = window.NINSAUDE_MEMED;

      /************************************************************
       * 2. CARREGA SCRIPT DA MEMED
       ************************************************************/
      function carregarMemed() {
        const script = document.createElement("script");
        script.src =
          "https://integrations.memed.com.br/modulos/plataforma.sinapse-prescricao/build/sinapse-prescricao.min.js";

        script.dataset.token = token;

        script.onload = iniciarIntegracao;
        document.body.appendChild(script);
      }

      /************************************************************
       * 3. INICIALIZAÇÃO
       ************************************************************/
      function iniciarIntegracao() {
        MdSinapsePrescricao.event.add(
          "core:moduleInit",
          async function (module) {
            if (module.name !== "plataforma.prescricao") return;

            // Envia paciente
            await MdHub.command.send(
              "plataforma.prescricao",
              "setPaciente",
              paciente
            );

            // Abre prescrição
            MdHub.module.show("plataforma.prescricao");
          }
        );

        registrarEventos();
      }

      /************************************************************
       * 4. EVENTOS (OBRIGATÓRIOS)
       ************************************************************/
      function registrarEventos() {
        MdHub.event.add("prescricaoImpressa", function () {
          // Apenas escutamos (boa prática Memed)
        });

        MdHub.event.add("prescricaoExcluida", function () {
          // Apenas escutamos
        });
      }

      /************************************************************
       * 5. START
       ************************************************************/
      carregarMemed();
    </script>

  </body>
</html>
