<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Memed integrada ao Ninsa√∫de</title>
</head>

<body>

  <button
    id="btnSimularPaciente"
    style="
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 9999;
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
    "
  >
    Simular paciente do Ninsa√∫de
  </button>

  <!-- Script da Memed -->
  <script
    src="https://integrations.memed.com.br/modulos/plataforma.sinapse-prescricao/build/sinapse-prescricao.min.js"
    data-token="SEU_TOKEN_AQUI">
  </script>

  <script>
    let pacienteRecebido = null;
    let integrado = false;

    // üîπ Recebe paciente (real ou simulado)
    window.addEventListener("message", function (event) {
      if (!event.data || event.data.type !== "PACIENTE_NINSAUDE") return;
      pacienteRecebido = event.data.payload;
    });

    // üîπ Espera o MdHub existir
    const waitForMdHub = setInterval(() => {
      if (!window.MdHub || !window.MdHub.command) return;

      clearInterval(waitForMdHub);

      MdHub.event.add("core:moduleInit", function (module) {
        if (module.name !== "plataforma.prescricao") return;
        if (integrado) return;

        integrado = true;

        if (!pacienteRecebido) {
          console.warn("Paciente ainda n√£o recebido do Ninsa√∫de");
          return;
        }

        integrarPaciente(pacienteRecebido);
      });
    }, 200);

    // üîπ Integra paciente + endere√ßo
    function integrarPaciente(p) {
      MdHub.command.send("plataforma.prescricao", "setPaciente", {
        nome: p.nome,
        sexo: p.sexo,
        dataNascimento: p.dataNascimento,
        documento: p.cpf,
        external_id: p.id
      });

      if (p.endereco) {
        MdHub.command.send("plataforma.prescricao", "setEnderecoPaciente", {
          logradouro: p.endereco.logradouro,
          numero: p.endereco.numero,
          complemento: p.endereco.complemento,
          bairro: p.endereco.bairro,
          cidade: p.endereco.cidade,
          uf: p.endereco.uf,
          cep: p.endereco.cep
        });
      }

      MdHub.command.send("plataforma.prescricao", "openPrescription");
      MdHub.module.show("plataforma.prescricao");
    }

    // üîπ BOT√ÉO DE SIMULA√á√ÉO (substitui console)
    document
      .getElementById("btnSimularPaciente")
      .addEventListener("click", function () {
        window.postMessage(
          {
            type: "PACIENTE_NINSAUDE",
            payload: {
              id: "ns-simulado-1",
              nome: "Maria da Silva",
              sexo: "F",
              dataNascimento: "1985-07-22",
              cpf: "12345678900",
              endereco: {
                logradouro: "Rua das Flores",
                numero: "123",
                bairro: "Centro",
                cidade: "S√£o Paulo",
                uf: "SP",
                cep: "01001000"
              }
            }
          },
          "*"
        );
      });
  </script>

</body>
</html>
