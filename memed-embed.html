<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Prescri√ß√£o ‚Äì Memed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #memed-container {
        width: 100%;
        height: 100vh;
      }
    </style>
  </head>

  <body>
    <div id="memed-container"></div>

    <script>
      /**
       * 1Ô∏è‚É£ DADOS DO PACIENTE
       * Esses dados DEVEM vir do Ninsa√∫de
       */
      const paciente = {
        id: "ninsaude-paciente-123",          // ID REAL DO NINSA√öDE
        nome: "Paciente Exemplo",
        telefone: "11999999999",
        cpf: "12345678901",
        email: "paciente@email.com",
        dataNascimento: "1990-01-01",
        endereco: "Rua Exemplo, 123 - S√£o Paulo/SP"
      };

      /**
       * 2Ô∏è‚É£ TOKEN DE PRODU√á√ÉO
       * Esse token deve ser INJETADO PELO BACKEND
       */
      const MEMED_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.WzkwMzg3LCIwYTZiZTgwM2U1YTcwNTg5NDJmZGQ2NmU3MzU2YWM1MSIsIjIwMjYtMDEtMjIiLCJzaW5hcHNlLnByZXNjcmljYW8iLCJwYXJ0bmVyLjMuODU1MjAiXQ.DbTqxosooGFCD6OhWW_ClktXPZN4B1Ecnev4OsavoXs";

      /**
       * 3Ô∏è‚É£ Carrega script da Memed
       */
      function carregarMemed() {
        const script = document.createElement("script");
        script.src =
          "https://integrations.memed.com.br/modulos/plataforma.sinapse-prescricao/build/sinapse-prescricao.min.js";

        script.dataset.token = MEMED_TOKEN;

        script.onload = () => {
          console.log("‚úÖ Script da Memed carregado");
          configurarEventos();
        };

        document.body.appendChild(script);
      }

      /**
       * 4Ô∏è‚É£ Configura√ß√£o dos eventos e paciente
       */
      function configurarEventos() {
        /**
         * Evento obrigat√≥rio ‚Äì salvar prescri√ß√£o no prontu√°rio
         */
        MdSinapsePrescricao.event.add(
          "prescricaoImpressa",
          function (payload) {
            console.log("üßæ Prescri√ß√£o impressa:", payload);

            // üëâ AQUI voc√™ envia para o backend do Ninsa√∫de
            fetch("/api/salvar-prescricao", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
          }
        );

        /**
         * Evento obrigat√≥rio ‚Äì prescri√ß√£o exclu√≠da
         */
        MdSinapsePrescricao.event.add(
          "prescricaoExcluida",
          function (payload) {
            console.log("üóëÔ∏è Prescri√ß√£o exclu√≠da:", payload);

            fetch("/api/excluir-prescricao", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
          }
        );

        /**
         * Aguarda m√≥dulo de prescri√ß√£o
         */
        MdSinapsePrescricao.event.add(
          "core:moduleInit",
          async function (module) {
            if (module.name === "plataforma.prescricao") {
              console.log("üü¢ M√≥dulo de prescri√ß√£o pronto");

              /**
               * 5Ô∏è‚É£ Envia paciente para a Memed
               */
              await MdHub.command.send(
                "plataforma.prescricao",
                "setPaciente",
                {
                  idExterno: paciente.id,
                  nome: paciente.nome,
                  telefone: paciente.telefone,
                  cpf: paciente.cpf,
                  email: paciente.email,
                  data_nascimento: paciente.dataNascimento,
                  endereco: paciente.endereco
                }
              );

              /**
               * 6Ô∏è‚É£ Abre a prescri√ß√£o
               */
              MdHub.module.show("plataforma.prescricao");
            }
          }
        );
      }

      /**
       * Inicializa√ß√£o
       */
      carregarMemed();
    </script>
  </body>
</html>
