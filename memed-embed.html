<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Memed integrada ao Ninsa√∫de</title>
</head>

<body>

  <!-- Script da Memed (HML) -->
  <script
    src="https://integrations.memed.com.br/modulos/plataforma.sinapse-prescricao/build/sinapse-prescricao.min.js"
    data-token="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.WzkwMzg3LCIwYTZiZTgwM2U1YTcwNTg5NDJmZGQ2NmU3MzU2YWM1MSIsIjIwMjYtMDEtMjIiLCJzaW5hcHNlLnByZXNjcmljYW8iLCJwYXJ0bmVyLjMuODU1MjAiXQ.DbTqxosooGFCD6OhWW_ClktXPZN4B1Ecnev4OsavoXs">
  </script>

  <script>
    let memedReady = false;
    let pacienteRecebido = null;

    // üîπ Recebe paciente do Ninsa√∫de (via postMessage)
    window.addEventListener("message", function (event) {
      // Em produ√ß√£o, restringir o origin:
      // if (event.origin !== "https://clinic.ninsaude.com.br") return;

      if (!event.data || event.data.type !== "PACIENTE_NINSAUDE") return;

      pacienteRecebido = event.data.payload;

      if (memedReady) {
        integrarPaciente(pacienteRecebido);
      }
    });

    // üîπ Memed pronta
    MdSinapsePrescricao.event.add("core:moduleInit", function (module) {
      if (module.name !== "plataforma.prescricao") return;

      memedReady = true;

      if (pacienteRecebido) {
        integrarPaciente(pacienteRecebido);
      }
    });

    // üîπ Integra paciente + endere√ßo
    function integrarPaciente(p) {
      // 1Ô∏è‚É£ Identidade do paciente
      MdHub.command.send("plataforma.prescricao", "setPaciente", {
        nome: p.nome,
        sexo: p.sexo,
        dataNascimento: p.dataNascimento,
        documento: p.cpf,
        external_id: p.id
      });

      // 2Ô∏è‚É£ Endere√ßo (OBRIGAT√ìRIO para controlados)
      if (p.endereco) {
        MdHub.command.send("plataforma.prescricao", "setEnderecoPaciente", {
          logradouro: p.endereco.logradouro,
          numero: p.endereco.numero,
          complemento: p.endereco.complemento,
          bairro: p.endereco.bairro,
          cidade: p.endereco.cidade,
          uf: p.endereco.uf,
          cep: p.endereco.cep
        });
      }

      // 3Ô∏è‚É£ Abre direto a prescri√ß√£o
      MdHub.command.send("plataforma.prescricao", "openPrescription");
      MdHub.module.show("plataforma.prescricao");
    }
  </script>

  <script>
  // üîî Escuta eventos da Memed
  MdHub.event.add("prescription.created", function (payload) {
    console.log("Prescri√ß√£o criada", payload);

    // Exemplo: avisar o Ninsa√∫de
    notificarNinsaude("created", payload);
  });

  MdHub.event.add("prescription.printed", function (payload) {
    console.log("Prescri√ß√£o impressa", payload);

    notificarNinsaude("printed", payload);
  });

  MdHub.event.add("prescription.deleted", function (payload) {
    console.log("Prescri√ß√£o exclu√≠da", payload);

    notificarNinsaude("deleted", payload);
  });

  function notificarNinsaude(tipo, payload) {
    // aqui voc√™ decide:
    // - postMessage
    // - fetch para backend
    // - extens√£o
    window.parent.postMessage(
      {
        type: "MEMED_PRESCRIPTION_EVENT",
        action: tipo,
        data: payload
      },
      "*"
    );
  }
</script>


</body>
</html>
